# â˜ï¸ Cloudflare Pages + Strapi Cloud Setup

**Environment variables configuration for split deployment**  
*Frontend: Cloudflare Pages | Backend: Strapi Cloud*

---

## ğŸ¯ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloudflare Pages      â”‚  API    â”‚    Strapi Cloud          â”‚
â”‚   (Next.js Frontend)    â”‚ â”€â”€â”€â”€â”€â”€> â”‚    (Strapi CMS)          â”‚
â”‚   ai2fin.com/blog       â”‚  HTTPS  â”‚    cms.strapiapp.com     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Part 1: Strapi Cloud Environment Variables

### Where to Set: Strapi Cloud Dashboard

1. Go to: https://cloud.strapi.io
2. Select your project
3. Go to **Settings** â†’ **Variables**

### Required Environment Variables

```env
# ============================================
# STRAPI CLOUD ENVIRONMENT VARIABLES
# Set these in Strapi Cloud Dashboard
# ============================================

# Node Environment
NODE_ENV=production

# CORS Configuration (CRITICAL!)
# Add your Cloudflare Pages domains
CORS_ORIGIN=https://ai2fin.com,https://www.ai2fin.com,https://ai2fin.pages.dev

# Public URL (Your Strapi Cloud URL)
# Example: https://automatic-positivity-3a6b42eb07.strapiapp.com
PUBLIC_URL=https://your-project.strapiapp.com

# Admin Panel URL (optional, default /admin)
ADMIN_URL=/admin

# Database (Automatically configured by Strapi Cloud)
# DATABASE_CLIENT=postgres
# DATABASE_HOST=...
# DATABASE_PORT=5432
# (These are auto-set by Strapi Cloud)

# Security Keys (Auto-generated by Strapi Cloud)
# APP_KEYS=...
# API_TOKEN_SALT=...
# ADMIN_JWT_SECRET=...
# JWT_SECRET=...
# TRANSFER_TOKEN_SALT=...
# (These are auto-generated, don't change unless needed)

# Optional: Email Provider (if needed)
# EMAIL_PROVIDER=sendgrid
# EMAIL_PROVIDER_API_KEY=your-sendgrid-key
# EMAIL_DEFAULT_FROM=noreply@ai2fin.com

# Optional: Upload Provider (if using S3/Cloudinary)
# UPLOAD_PROVIDER=cloudinary
# CLOUDINARY_NAME=your-cloud-name
# CLOUDINARY_KEY=your-key
# CLOUDINARY_SECRET=your-secret
```

### âš ï¸ CRITICAL: CORS_ORIGIN

This is the **most important** setting. Add ALL your frontend domains:

```env
CORS_ORIGIN=https://ai2fin.com,https://www.ai2fin.com,https://ai2fin.pages.dev,https://preview.ai2fin.pages.dev
```

**Include:**
- âœ… Production domain: `https://ai2fin.com`
- âœ… WWW variant: `https://www.ai2fin.com`
- âœ… Cloudflare Pages domain: `https://ai2fin.pages.dev`
- âœ… Preview branches: `https://preview-branch.ai2fin.pages.dev`

**DO NOT include:**
- âŒ `http://` (non-secure)
- âŒ Trailing slashes
- âŒ Wildcards like `*`

---

## ğŸ“ Part 2: Cloudflare Pages Environment Variables

### Where to Set: Cloudflare Dashboard

1. Go to: https://dash.cloudflare.com
2. Select **Pages**
3. Select your project
4. Go to **Settings** â†’ **Environment Variables**

### Required Environment Variables

```env
# ============================================
# CLOUDFLARE PAGES ENVIRONMENT VARIABLES
# Set these in Cloudflare Pages Dashboard
# ============================================

# Strapi Connection
STRAPI_BASE_URL=https://your-project.strapiapp.com
STRAPI_API_TOKEN=your-read-only-token-here

# Next.js Configuration
NEXT_PUBLIC_SITE_URL=https://ai2fin.com

# Optional: Analytics
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
```

### ğŸ”‘ How to Get STRAPI_API_TOKEN

1. Go to Strapi Cloud admin panel: `https://your-project.strapiapp.com/admin`
2. Navigate to **Settings** â†’ **API Tokens**
3. Click **Create new API Token**
4. Configure:
   - **Name**: `Cloudflare Pages Frontend`
   - **Token type**: `Read-only` (recommended) or `Custom`
   - **Duration**: `Unlimited` or `90 days`
   - If Custom, select:
     - Article: `find` âœ…, `findOne` âœ…
     - Author: `find` âœ…, `findOne` âœ…
     - Category: `find` âœ…, `findOne` âœ…
     - Tag: `find` âœ…, `findOne` âœ…
5. Click **Save**
6. **Copy the token** (shown only once!)
7. Paste in Cloudflare Pages: `STRAPI_API_TOKEN=<copied-token>`

---

## ğŸ“‹ Environment Variables by Platform

### âœ… Set in **Strapi Cloud Dashboard**

| Variable | Value | Purpose |
|----------|-------|---------|
| `CORS_ORIGIN` | `https://ai2fin.com,...` | Allow frontend requests |
| `PUBLIC_URL` | `https://your-project.strapiapp.com` | Base URL for media |
| `NODE_ENV` | `production` | Production mode |

### âœ… Set in **Cloudflare Pages Dashboard**

| Variable | Value | Purpose |
|----------|-------|---------|
| `STRAPI_BASE_URL` | `https://your-project.strapiapp.com` | API connection |
| `STRAPI_API_TOKEN` | `your-token` | Authentication |
| `NEXT_PUBLIC_SITE_URL` | `https://ai2fin.com` | Canonical URL |

---

## ğŸ”§ Step-by-Step Setup

### Step 1: Configure Strapi Cloud

```bash
# 1. Login to Strapi Cloud
https://cloud.strapi.io

# 2. Add CORS_ORIGIN
Settings â†’ Variables â†’ Add Variable
Name: CORS_ORIGIN
Value: https://ai2fin.com,https://www.ai2fin.com,https://ai2fin.pages.dev

# 3. Save and Redeploy
Click "Save" â†’ Strapi will automatically redeploy
```

### Step 2: Get Strapi URL

Your Strapi Cloud URL will be like:
```
https://automatic-positivity-3a6b42eb07.strapiapp.com
```

Copy this URL - you'll need it for Cloudflare Pages.

### Step 3: Create API Token

```bash
# In Strapi admin panel
https://your-project.strapiapp.com/admin

# Navigate to:
Settings â†’ API Tokens â†’ Create new API Token

# Copy the generated token
```

### Step 4: Configure Cloudflare Pages

```bash
# 1. Go to Cloudflare Dashboard
https://dash.cloudflare.com

# 2. Navigate to
Pages â†’ Your Project â†’ Settings â†’ Environment Variables

# 3. Add Production Variables
Variable: STRAPI_BASE_URL
Value: https://your-project.strapiapp.com

Variable: STRAPI_API_TOKEN
Value: <paste-token-here>

Variable: NEXT_PUBLIC_SITE_URL
Value: https://ai2fin.com

# 4. Save
```

### Step 5: Update Frontend Code (if needed)

Your frontend at `Website Front/Website Front/` should already use these env vars:

```typescript
// lib/cms/strapi.ts
const STRAPI_BASE_URL = process.env['STRAPI_BASE_URL'] || '';
const STRAPI_API_TOKEN = process.env['STRAPI_API_TOKEN'] || '';
```

âœ… No code changes needed - it's already configured!

### Step 6: Redeploy Frontend

```bash
# Cloudflare Pages will auto-deploy on git push
git add .
git commit -m "Update environment config"
git push origin main

# Or trigger manual deployment in Cloudflare Dashboard
```

---

## ğŸ§ª Testing the Connection

### Test 1: CORS Configuration

```bash
# From browser console on ai2fin.com
fetch('https://your-project.strapiapp.com/api/articles')
  .then(r => r.json())
  .then(console.log)
```

âœ… **Expected**: JSON data  
âŒ **CORS Error**: Check `CORS_ORIGIN` in Strapi Cloud

### Test 2: API Token

```bash
# Test with token
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-project.strapiapp.com/api/articles
```

âœ… **Expected**: JSON data  
âŒ **401 Unauthorized**: Token is invalid/expired

### Test 3: Frontend Blog Page

Visit: `https://ai2fin.com/blog`

âœ… **Expected**: Articles load  
âŒ **Empty/Error**: Check browser console for errors

---

## ğŸ” Troubleshooting

### Issue: CORS Error

**Error in browser console:**
```
Access to fetch at 'https://...strapiapp.com/api/articles' 
from origin 'https://ai2fin.com' has been blocked by CORS policy
```

**Fix:**
1. Go to Strapi Cloud â†’ Settings â†’ Variables
2. Check `CORS_ORIGIN` includes `https://ai2fin.com`
3. No spaces, comma-separated
4. Save and wait for redeploy (2-3 minutes)

### Issue: API Returns 401

**Error:**
```json
{ "error": "Unauthorized" }
```

**Fix:**
1. Check `STRAPI_API_TOKEN` is set in Cloudflare Pages
2. Verify token hasn't expired (check Strapi Cloud)
3. Ensure token has read permissions for Article, Author, etc.

### Issue: Images Not Loading

**Images return 404 or don't display**

**Fix:**
1. Check `PUBLIC_URL` in Strapi Cloud matches your Strapi URL
2. Verify `CORS_ORIGIN` allows image requests
3. In Strapi Cloud: Settings â†’ Media Library â†’ Check public access

### Issue: Frontend Shows Old Data

**Articles not updating**

**Fix:**
1. Check Next.js ISR revalidation (default: 60s)
2. Clear Cloudflare cache:
   ```bash
   Cloudflare Dashboard â†’ Caching â†’ Purge Cache
   ```
3. Rebuild frontend in Cloudflare Pages

---

## ğŸŒ Environment-Specific Configuration

### Production

```env
# Cloudflare Pages - Production
STRAPI_BASE_URL=https://your-production.strapiapp.com
STRAPI_API_TOKEN=prod_token_here
NEXT_PUBLIC_SITE_URL=https://ai2fin.com
```

### Preview/Staging

Cloudflare Pages supports **Preview Environments** per branch:

```env
# Set different variables for preview branches
# Cloudflare Pages â†’ Settings â†’ Environment Variables â†’ Preview

STRAPI_BASE_URL=https://your-staging.strapiapp.com
STRAPI_API_TOKEN=staging_token_here
NEXT_PUBLIC_SITE_URL=https://preview.ai2fin.pages.dev
```

---

## ğŸ” Security Best Practices

### âœ… DO:
- Use **Read-Only** API tokens for frontend
- Set token expiration (90 days)
- Use HTTPS only (Cloudflare enforces this)
- Limit CORS to specific domains
- Rotate tokens every 3-6 months
- Keep tokens in environment variables (never in code)

### âŒ DON'T:
- Commit tokens to Git
- Use Full Access tokens for frontend
- Allow CORS `*` wildcard
- Share tokens between environments
- Use admin tokens for public API

---

## ğŸ“Š Architecture Checklist

- [ ] Strapi Cloud project created
- [ ] CORS_ORIGIN configured with all frontend domains
- [ ] API Token created (Read-Only)
- [ ] API permissions set to Public (find, findOne)
- [ ] Cloudflare Pages environment variables set
- [ ] Frontend code uses correct env var names
- [ ] Test CORS from browser console
- [ ] Test API endpoint returns data
- [ ] Blog page loads articles
- [ ] Images display correctly
- [ ] Custom domain configured (ai2fin.com)

---

## ğŸš€ Deployment Flow

```
1. Developer pushes code to Git
   â†“
2. Cloudflare Pages auto-deploys frontend
   â†“
3. Frontend fetches data from Strapi Cloud
   (using STRAPI_BASE_URL + STRAPI_API_TOKEN)
   â†“
4. Strapi Cloud checks CORS_ORIGIN
   â†“
5. If allowed, returns JSON data
   â†“
6. Frontend renders blog with Strapi content
```

---

## ğŸ“ Quick Reference

### Strapi Cloud URLs
- **Admin Panel**: `https://your-project.strapiapp.com/admin`
- **API Base**: `https://your-project.strapiapp.com/api`
- **Dashboard**: `https://cloud.strapi.io`

### Cloudflare Pages URLs
- **Dashboard**: `https://dash.cloudflare.com`
- **Production**: `https://ai2fin.com`
- **Pages Domain**: `https://ai2fin.pages.dev`

### Key Files (Frontend)
- `lib/cms/strapi.ts` - API integration
- `.env.local` (local dev only)
- Environment variables set in Cloudflare Dashboard (production)

---

## ğŸ“ Example Configuration

### Real-World Setup

**Strapi Cloud Variables:**
```env
CORS_ORIGIN=https://ai2fin.com,https://www.ai2fin.com,https://ai2fin-blog.pages.dev
PUBLIC_URL=https://automatic-positivity-3a6b42eb07.strapiapp.com
NODE_ENV=production
```

**Cloudflare Pages Variables:**
```env
STRAPI_BASE_URL=https://automatic-positivity-3a6b42eb07.strapiapp.com
STRAPI_API_TOKEN=abc123...xyz789
NEXT_PUBLIC_SITE_URL=https://ai2fin.com
```

---

## ğŸ†˜ Getting Help

### Strapi Cloud Support
- Dashboard: https://cloud.strapi.io
- Docs: https://docs.strapi.io/cloud
- Support: support@strapi.io

### Cloudflare Pages Support
- Dashboard: https://dash.cloudflare.com
- Docs: https://developers.cloudflare.com/pages
- Community: https://community.cloudflare.com

---

**âœ… Once configured, your blog will automatically:**
- Fetch content from Strapi Cloud
- Render on Cloudflare Pages
- Update every 60 seconds (ISR)
- Scale to millions of users
- Work globally with Cloudflare CDN

**Built with embracingearth.space architecture**  
*Secure â€¢ Scalable â€¢ High-Performance*

