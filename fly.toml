# Fly.io Configuration for Strapi CMS
# Cost-optimized for minimal resource usage while maintaining availability
# embracingearth.space - Enterprise-grade deployment architecture
# Audited and fixed: 2026-01-03

app = "strapi-cloud-template-blog-3f0dd9f7fb"
primary_region = "syd"  # Sydney, Australia (change to your preferred region)

[build]
  dockerfile = "Dockerfile"

[env]
  NODE_ENV = "production"
  HOST = "0.0.0.0"
  PORT = "1337"

# Minimal resource allocation for cost efficiency
# shared-cpu-1x = cheapest option, 256MB RAM
# Auto-restart ensures availability despite minimal resources
[[vm]]
  memory_mb = 256
  cpu_kind = "shared"
  cpus = 1

# Health check for auto-restart and availability
[http_service]
  internal_port = 1337
  force_https = true
  auto_stop_machines = false  # Keep running for always-available
  auto_start_machines = true
  min_machines_running = 1    # Always keep 1 instance running
  processes = ["app"]

  [[http_service.checks]]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    timeout = "5s"
    path = "/_health"

# Process configuration
[[processes]]
  name = "app"
  cmd = ["npm", "start"]

# Restart policy for high availability
[restart]
  policy = "always"  # Always restart on failure
  max_retries = 10
  max_backoff = "5m"

# Resource limits to prevent resource exhaustion
[limits]
  memory_mb = 256
  memory_swap_mb = 512  # Allow swap for memory spikes

# Metrics and observability (optional)
[metrics]
  port = 9091
  path = "/metrics"
